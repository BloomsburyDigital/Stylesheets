<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="teiFilesToOdt" name="StylesheetsTestOdt"
  xmlns:if="ant:if"
  xmlns:unless="ant:unless">
  
  <description> 
    Stylesheets/Test2/odt.xml
    
    ANT TEST FILE FOR CONVERSIONS BETWEEN TEI AND ODT.
    
    
  </description>


  <!-- First we include the generic utilities module.   -->
  <import file="utilities.xml" as="utils"/>
  
  <!-- The odt file we need to call. -->
  <import file="../odt/build-to.xml"/>
  
  <!--  Files for conversion to ODT.  -->
  <fileset id="teiToOdtFiles" dir="${inputDir}" includes="generalP5.xml"/>
  
  
<!-- Default target that does everything. -->
  <target name="odt">
    <antcall target="teiFilesToOdt"/>
  </target>
  
  <target name="teiFilesToOdt">
    <description>
      TARGET teiFilesToOdt
      Converts TEI files to odt, extracts their contents.xml, 
      and diffs them against expected results.
    </description>
    <foreach target="teiFileToOdt" param="inFile">
      <path>
        <fileset refid="teiToOdtFiles"/>
      </path>
    </foreach>
  </target>
  
  <target name="teiFileToOdt">
    <description>
      TARGET teiFileToOdt
      Converts a single TEI file to odt, then extracts the content.xml from
      the result and diffs it against expected results. It takes a single
      parameter, inFile.
    </description>
    <basename file="${inFile}" property="plainFileName" suffix=".xml"/>
    <property name="outFile" value="${outputDir}/${plainFileName}.odt"/>
    
<!-- NOTE: ultimately we want to do this conversion by calling ant directly on the 
    ../odt/build-to.xml file, but it seems impossible to make this work; ant cannot
    find the main Saxon class. -->
    <exec executable="${bin}/teitoodt" failonerror="true">
      <arg line="--localsource=${localsource}"/>
      <arg file="${inFile}"/>
      <arg file="${outFile}"/>
    </exec>
    
<!-- Make a temp dir and unzip the ODT file.        -->
    <mkdir dir="${outputDir}/temp"/>
    <unzip src="${outFile}" dest="${outputDir}/temp"/>
    <copy file="${outputDir}/temp/content.xml" tofile="${outputDir}/temp/${plainFileName}OdtContent.xml"/>
    
    
    <antcall target="prepAndDiffFile">
      <param name="inFile" value="${outputDir}/temp/${plainFileName}OdtContent.xml"/>
    </antcall>
  </target>
  
  
  
</project>